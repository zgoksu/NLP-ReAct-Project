# -*- coding: utf-8 -*-
"""eval.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1atPpLNYFJ31i_H2Ly9yuI1Ldfq6QkqPo
"""

def query_and_capture(question, max_turns=5):
    agent = Agent(system_prompt)
    next_prompt = question
    action_re = re.compile(r'^Action:\s*(\w+):\s*(.*)$', re.MULTILINE)

    full_output = ""

    for _ in range(max_turns):
        result = agent(next_prompt)
        full_output += result + "\n"

        if "Answer:" in result:
            break

        actions = [action_re.match(line) for line in result.split("\n") if action_re.match(line)]
        if actions:
            action, action_input = actions[0].groups()
            observation = known_actions[action](action_input.strip())
            next_prompt = f"Observation: {observation}"
        else:
            next_prompt = "Continue analysis."

    return full_output

with open("test_dataset.json", "r", encoding="utf-8") as f:
    test_data = json.load(f)

results = []

for test in test_data:
    print(f"\n Testing ID {test['id']} | Command: {test['command']}")

    prompt = f"""
Analyze the following command:
{test['command']}
"""

    output = query_and_capture(prompt)

    results.append({
        "id": test["id"],
        "command": test["command"],
        "expected_label": test["expected_label"],
        "expected_risk": test["risk_level"],
        "model_output": output
    })
